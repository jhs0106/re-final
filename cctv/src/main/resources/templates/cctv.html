<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>home cam</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            font-family: sans-serif;
        }

        video {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            border: 2px solid #333;
        }

        .info {
            margin-top: 10px;
            text-align: center;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            background: #333;
        }

        .badge.on {
            background: #28a745;
            color: white;
        }

        .badge.processing {
            background: #ffc107;
            color: #000;
        }
    </style>
</head>

<body>
    <h2 id="title">CAM ì´ˆê¸°í™” ì¤‘...</h2>
    <video id="preview" autoplay playsinline muted></video>
    <div class="info">
        <span id="status" class="badge">ì—°ê²° ëŒ€ê¸°</span>
        <span id="ai-status" class="badge">AI ì¤€ë¹„</span>
        <p id="log" style="font-size: 0.8rem; color: #aaa;">...</p>
    </div>

    <script th:inline="javascript">
        // ==========================================
        // [ì„¤ì •] ë‚´ IP ì£¼ì†Œ ì…ë ¥ (Admin ì„œë²„)
        // ==========================================
        const SIGNALING_PROTOCOL = location.protocol === "https:" ? "wss" : "ws";
        const SIGNALING_URL = `${SIGNALING_PROTOCOL}://${location.hostname}:8443/signal`;
        const ANALYSIS_ENDPOINT = `${location.protocol}//${location.hostname}:8443/cctv/api/analysis`;
        const ANALYSIS_INTERVAL = 30000;

        // 1. ID ìƒì„±
        let serverId = [[${ cctvId }]];
        if (!serverId) serverId = "";
        const urlParams = new URLSearchParams(window.location.search);
        const CCTV_ID = serverId || urlParams.get('id') || 'cctv-' + Math.floor(Math.random() * 1000);

        document.getElementById('title').textContent = `ğŸ“· CCTV: ${CCTV_ID}`;
        document.title = `CCTV - ${CCTV_ID}`;

        const videoEl = document.getElementById('preview');
        const statusEl = document.getElementById('status');
        const aiStatusEl = document.getElementById('ai-status');
        const logEl = document.getElementById('log');

        let socket;
        let peerConnection;
        let localStream;

        function log(msg) { logEl.textContent = msg; console.log(msg); }

        async function startCamera() {
            try {
                // [ìˆ˜ì •] ëª¨ë°”ì¼ í›„ë©´ ì¹´ë©”ë¼ ìš°ì„  ì‚¬ìš© (PCëŠ” ìë™ ì„ íƒ)
                const constraints = {
                    video: {
                        facingMode: { ideal: "environment" }
                    },
                    audio: false
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoEl.srcObject = localStream;
                log("ì¹´ë©”ë¼ ì‘ë™. ì„œë²„ ì—°ê²° ì‹œë„...");

                connectSocket();

                // AI ë¶„ì„ ë£¨í”„ ì‹œì‘
                setInterval(runAnalysis, ANALYSIS_INTERVAL);

            } catch (e) {
                log("ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜: " + e.message);
            }
        }

        function connectSocket() {
            socket = new WebSocket(SIGNALING_URL);

            socket.onopen = () => {
                statusEl.className = "badge on";
                statusEl.textContent = "ì„œë²„ ì—°ê²°ë¨";
                log("ëŒ€ê¸° ì¤‘...");
            };

            socket.onclose = () => {
                statusEl.className = "badge";
                statusEl.textContent = "ì—°ê²° ëŠê¹€";
                setTimeout(connectSocket, 3000);
            };

            socket.onmessage = async (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === 'viewer_joined') {
                    const delay = Math.floor(Math.random() * 3000);
                    log(`ê´€ë¦¬ì ì ‘ì†! ${delay}ms í›„ ì—°ê²°`);

                    setTimeout(async () => {
                        createPeerConnection();
                        const offer = await peerConnection.createOffer();
                        await peerConnection.setLocalDescription(offer);
                        send({ type: 'offer', id: CCTV_ID, sdp: offer.sdp });
                    }, delay);
                }
                else if (msg.type === 'answer' && msg.id === CCTV_ID) {
                    if (peerConnection) await peerConnection.setRemoteDescription(new RTCSessionDescription(msg));
                }
                else if (msg.type === 'candidate' && msg.id === CCTV_ID) {
                    if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(msg.candidate));
                }
            };
        }

        function send(data) {
            if (socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify(data));
        }

        function createPeerConnection() {
            if (peerConnection) peerConnection.close();
            peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            peerConnection.onicecandidate = (e) => {
                if (e.candidate) send({ type: 'candidate', id: CCTV_ID, candidate: e.candidate });
            };
        }

        // [ë³µêµ¬] AI ë¶„ì„ ë¡œì§
        async function runAnalysis() {
            if (!videoEl.videoWidth) return;

            aiStatusEl.className = "badge processing";
            aiStatusEl.textContent = "ë¶„ì„ ì¤‘...";

            const canvas = document.createElement('canvas');
            canvas.width = videoEl.videoWidth;
            canvas.height = videoEl.videoHeight;
            canvas.getContext('2d').drawImage(videoEl, 0, 0);

            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('question', "ê°€ì •ìš© ë°˜ë ¤ë™ë¬¼ ëŒë´„ ì¹´ë©”ë¼ì•¼. í™”ë©´ì— ë°˜ë ¤ë™ë¬¼ì´ ëª…í™•íˆ ë³´ì´ì§€ ì•Šìœ¼ë©´ 'ë°˜ë ¤ë™ë¬¼ì´ íƒìƒ‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤'ë§Œ ë‹µí•´. ë³´ì´ë©´ ê±´ê°•/ê¸°ë¶„/ì•ˆì „ ìƒíƒœë¥¼ ê°„ë‹¨í•œ í•œêµ­ì–´ë¡œ ìš”ì•½í•˜ê³  ìœ„í—˜í•˜ê±°ë‚˜ ì´ìƒí•˜ë©´ 'ìœ„í—˜', í‰ì†Œì²˜ëŸ¼ ë³´ì´ë©´ 'ì •ìƒ'ì´ë¼ê³  í¬í•¨í•´ì¤˜.");
                formData.append('attach', blob, 'frame.png');
                formData.append('cctvId', CCTV_ID);

                try {
                    const res = await fetch(ANALYSIS_ENDPOINT, { method: 'POST', body: formData });
                    const text = await res.text(); // ì„œë²„ ì‘ë‹µ (NDJSON ë“±)

                    if (text.includes('NO_PET_VISIBLE')) {
                        aiStatusEl.className = "badge";
                        aiStatusEl.textContent = "ë°˜ë ¤ë™ë¬¼ ë¯¸í™•ì¸";
                        return;
                    }

                    const cleaned = text.trim();
                    let severity = 'normal';
                    let message = cleaned ? cleaned.substring(0, 100) : 'ì´ìƒ ì—†ìŒ';

                    if (/alert|ìœ„í—˜|ë¶€ìƒ|êµ¬í† |ë¬´ê¸°ë ¥|í˜¸í¡ ì´ìƒ/i.test(cleaned)) {
                        severity = 'alert';
                    }

                    // ê²°ê³¼ ì „ì†¡
                    send({
                        type: 'CCTV_ANALYSIS_RESULT',
                        payload: {
                            cctvId: CCTV_ID,
                            severity: severity,
                            message: message,
                            timestamp: new Date().toISOString()
                        }
                    });

                    aiStatusEl.className = "badge on";
                    aiStatusEl.textContent = "ë¶„ì„ ì™„ë£Œ";

                } catch (e) {
                    console.error(e);
                    aiStatusEl.className = "badge";
                    aiStatusEl.textContent = "ë¶„ì„ ì‹¤íŒ¨";
                }
            });
        }

        startCamera();
    </script>
</body>

</html>